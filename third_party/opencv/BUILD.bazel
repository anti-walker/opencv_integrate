load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

package(default_visibility = ["//visibility:public"])

cmake(
    name = "opencv_arm64",
    cache_entries = {
        "BUILD_SHARED_LIBS": "ON",
        "CMAKE_BUILD_TYPE": "Release",
        "CMAKE_INSTALL_PREFIX": "$$INSTALLDIR$$",
        "CMAKE_EXE_LINKER_FLAGS": "-static-libgcc -static-libstdc++",
        "CMAKE_SYSTEM_NAME": "Linux",
        "CMAKE_SYSTEM_PROCESSOR": "aarch64",
        "CMAKE_C_COMPILER": "/usr/bin/aarch64-linux-gnu-gcc",
        "CMAKE_CXX_COMPILER": "/usr/bin/aarch64-linux-gnu-g++",
        "CMAKE_SYSROOT": "/usr/aarch64-linux-gnu",

        # "BUILD_LIST": "core,imgproc,imgcodecs,highgui",  # will build all main modules without build_list
        "BUILD_TESTS": "OFF",
        "BUILD_PERF_TESTS": "OFF",
        "BUILD_EXAMPLES": "OFF",
        "BUILD_opencv_gapi": "OFF",
        "BUILD_opencv_ts": "OFF",
        "BUILD_opencv_apps": "OFF",
        "WITH_FFMPEG": "ON",
        "BUILD_FFMPEG": "ON",
    },
    lib_source = "@opencv_src//:all_srcs",
    out_include_dir = "include/opencv4",
    out_shared_libs = [
        "libopencv_core.so.410",
        "libopencv_calib3d.so.410",
        "libopencv_dnn.so.410",
        "libopencv_features2d.so.410",
        "libopencv_flann.so.410",
        "libopencv_highgui.so.410",
        "libopencv_imgcodecs.so.410",
        "libopencv_imgproc.so.410",
        "libopencv_ml.so.410",
        "libopencv_objdetect.so.410",
        "libopencv_photo.so.410",
        "libopencv_stitching.so.410",
        "libopencv_video.so.410",
        "libopencv_videoio.so.410",
    ],
    target_compatible_with = [
        "@platforms//cpu:aarch64",
        "@platforms//os:linux",
    ],
)

cmake(
    name = "opencv_x86",
    cache_entries = {
        "BUILD_SHARED_LIBS": "ON",
        # "BUILD_LIST": "core,imgproc,imgcodecs,highgui",  # will build all main modules without build_list
        "BUILD_TESTS": "OFF",
        "BUILD_PERF_TESTS": "OFF",
        "BUILD_EXAMPLES": "OFF",
        "BUILD_opencv_apps": "OFF",
        "BUILD_opencv_ts": "OFF",
        "BUILD_opencv_gapi": "OFF",
        "WITH_FFMPEG": "ON",
        "BUILD_FFMPEG": "ON",
        # "WITH_QT": "OFF",
        # "WITH_GDAL": "OFF",
        # "WITH_FFMPEG": "OFF",
        # "WITH_IPP": "OFF",
        # "WITH_OPENGL": "OFF",
        # "WITH_TBB": "OFF",
        # "WITH_CUDA": "OFF",
        # "WITH_OPENCL": "OFF",
        "CMAKE_BUILD_TYPE": "Release",
    },
    lib_source = "@opencv_src//:all_srcs",
    out_include_dir = "include/opencv4",
    out_shared_libs = [
        "libopencv_core.so.410",
        "libopencv_calib3d.so.410",
        "libopencv_dnn.so.410",
        "libopencv_features2d.so.410",
        "libopencv_flann.so.410",
        "libopencv_highgui.so.410",
        "libopencv_imgcodecs.so.410",
        "libopencv_imgproc.so.410",
        "libopencv_ml.so.410",
        "libopencv_objdetect.so.410",
        "libopencv_photo.so.410",
        "libopencv_stitching.so.410",
        "libopencv_video.so.410",
        "libopencv_videoio.so.410",
        # "libopencv_gapi.so.410",
        # "libopencv_ts.so.410",
    ],
)

alias(
    name = "opencv",
    actual = select({
        "//bazel/platforms:config_arm": ":opencv_arm64",
        "//conditions:default": ":opencv_x86",
    }),
    visibility = ["//visibility:public"],
)
