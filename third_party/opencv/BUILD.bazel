load("@rules_foreign_cc//foreign_cc:defs.bzl", "cmake")

package(default_visibility = ["//visibility:public"])

cmake(
    name = "opencv_libs",
    cache_entries = {
        "BUILD_SHARED_LIBS": "ON",  # 动态库
        # "BUILD_LIST": "core,imgproc,imgcodecs,highgui",  # 核心模块，加速构建
        # "BUILD_LIST": "core",  # 核心模块，加速构建
        "BUILD_TESTS": "OFF",
        "BUILD_PERF_TESTS": "OFF",
        "BUILD_EXAMPLES": "OFF",
        "BUILD_opencv_apps": "OFF",
        "BUILD_opencv_ts": "OFF",
        "BUILD_opencv_gapi": "OFF",
        "WITH_FFMPEG": "ON",
        "BUILD_FFMPEG": "ON",
        # "WITH_QT": "OFF",
        # "WITH_GDAL": "OFF",
        # "WITH_FFMPEG": "OFF",
        # "WITH_IPP": "OFF",
        # "WITH_OPENGL": "OFF",
        # "WITH_TBB": "OFF",
        # "WITH_CUDA": "OFF",
        # "WITH_OPENCL": "OFF",
        "CMAKE_BUILD_TYPE": "Release",
    },
    lib_source = "@opencv_src//:all_srcs",
    # 关键：OpenCV 4.x 安装后头文件在 include/opencv4/opencv2/
    out_include_dir = "include/opencv4",
    # out_shared_libs = glob(["libopencv_*.so*"]),
    # 关键：明确列出真实文件 + 两个符号链接
    out_shared_libs = [
        "libopencv_calib3d.so.410",
        "libopencv_core.so.410",
        "libopencv_dnn.so.410",
        "libopencv_features2d.so.410",
        "libopencv_flann.so.410",
        # "libopencv_gapi.so.410",
        "libopencv_highgui.so.410",
        "libopencv_imgcodecs.so.410",
        "libopencv_imgproc.so.410",
        "libopencv_ml.so.410",
        "libopencv_objdetect.so.410",
        "libopencv_photo.so.410",
        "libopencv_stitching.so.410",
        # "libopencv_ts.so.410",
        "libopencv_video.so.410",
        "libopencv_videoio.so.410",
    ],
)

# 用 alias 或 filegroup 暴露给下游（cmake 规则本身已自动传播 include 和库）
alias(
    name = "opencv",
    actual = ":opencv_libs",
)
